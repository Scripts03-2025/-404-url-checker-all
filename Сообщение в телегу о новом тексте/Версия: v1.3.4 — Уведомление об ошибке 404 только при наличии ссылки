/**
 * üì® Telegram Notification Script
 * ------------------------------------
 * üìõ –í–µ—Ä—Å–∏—è: v1.3.4 ‚Äî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ 404 —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å—Å—ã–ª–∫–∏
 * –í–†–û–î–ï –†–ê–ë–û–¢–ê–ï–¢
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Google –¢–∞–±–ª–∏—Ü—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "404 (–Ω–µ –º–µ–Ω—è—Ç—å!)" –Ω–∞—á–∏–Ω–∞—è —Å 7-–π —Å—Ç—Ä–æ–∫–∏.
 * –ï—Å–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ B –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ (–±–µ–∑ –ø–æ–º–µ—Ç–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ C),
 * —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–º–µ—Ç–∫—É –≤–∏–¥–∞:
 * "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 25.03.2025 16:00" –≤ –∫–æ–ª–æ–Ω–∫—É C.
 * –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞.
 * –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –≤–æ –≤–∫–ª–∞–¥–∫—É "–õ–æ–≥ —Å–∫—Ä–∏–ø—Ç–æ–≤" –æ—Ç —Å—Ç–æ–ª–±—Ü–∞ M (7-—è —Å—Ç—Ä–æ–∫–∞),
 * –ø—Ä–∏ —ç—Ç–æ–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ 7-—é —Å—Ç—Ä–æ–∫—É, –∞ –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–Ω–∏–∑.
 * 
 * üîÑ –í–µ—Ä—Å–∏–∏:
 * v1.0.0 ‚Äî –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫ –∏ –ø–æ–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏)
 * v1.1.0 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–æ–≥ –≤–µ—Ä—Å–∏–π (25.03.2025)
 * v1.2.0 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (25.03.2025)
 * v1.3.0 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É (26.03.2025)
 * v1.3.1 ‚Äî –õ–æ–≥ –ø–∏—à–µ—Ç—Å—è –Ω–∞ 7-—é —Å—Ç—Ä–æ–∫—É, –∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤–Ω–∏–∑ (26.03.2025)
 * v1.3.4 ‚Äî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ 404 —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ B (27.03.2025)
 * 
 * üí¨ –°–¥–µ–ª–∞–Ω–æ –≤ ChatGPT: https://chatgpt.com/c/67e2e09a-1b20-8010-8992-ecfebfcfe5c0
 */

const TELEGRAM_TOKEN = '8136586676:AAHvXeM4ih9ECPdSwzGM5P0O1p2_GYb_iTk';
const TELEGRAM_CHAT_ID = '8003377702'; // ‚Üê —Ç–≤–æ–π chat_id

function checkNewLinksAndNotify() {
  const sheetName = '404 (–Ω–µ –º–µ–Ω—è—Ç—å!)';
  const linkColumn = 2; // –∫–æ–ª–æ–Ω–∫–∞ B
  const statusColumn = 3; // –∫–æ–ª–æ–Ω–∫–∞ C

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const data = sheet.getRange(7, 1, sheet.getLastRow() - 6, 6).getValues(); // –∫–æ–ª–æ–Ω–∫–∏ A‚ÄìF –Ω–∞—á–∏–Ω–∞—è —Å 7-–π —Å—Ç—Ä–æ–∫–∏
  const statuses = sheet.getRange(7, statusColumn, data.length).getValues();

  let processedCount = 0;
  let errors = [];

  for (let i = 0; i < data.length; i++) {
    const url = data[i][1]; // –∫–æ–ª–æ–Ω–∫–∞ B
    const status = statuses[i][0];
    const rawAuthor = data[i][5]; // –∫–æ–ª–æ–Ω–∫–∞ F
    const authorInitial = rawAuthor ? rawAuthor.trim().charAt(0).toUpperCase() + '.' : '–ù–µ —É–∫–∞–∑–∞–Ω';

    if (url && !status) {
      const message = `üì∞ –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–º–µ—â—ë–Ω:\n${url}\n\nüë§ –ö—Ç–æ —Ä–∞–∑–º–µ—Å—Ç–∏–ª: ${authorInitial}`;
      const result = sendTelegramMessage(message);

      const now = new Date();
      const formattedTime = Utilities.formatDate(now, Session.getScriptTimeZone(), 'dd.MM.yyyy HH:mm');
      const statusMessage = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${formattedTime}`;

      if (result.success) {
        sheet.getRange(i + 7, statusColumn).setValue(statusMessage); // –ü–∏—à–µ–º –≤ C
        processedCount++;
      } else {
        errors.push(result.error);
      }

      SpreadsheetApp.flush();
    }
  }

  logScriptRun(processedCount, errors);

  // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ 404 –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  for (let i = 0; i < data.length; i++) {
    const statusCode = data[i][3]; // –∫–æ–ª–æ–Ω–∫–∞ D (–∫–æ–¥ –æ—Ç–≤–µ—Ç–∞)
    const url = data[i][1];        // –∫–æ–ª–æ–Ω–∫–∞ B (—Å—Å—ã–ª–∫–∞)
    const id = data[i][0];         // –∫–æ–ª–æ–Ω–∫–∞ A (ID)
    const rawAuthor = data[i][5];  // –∫–æ–ª–æ–Ω–∫–∞ F (–∫—Ç–æ —Ä–∞–∑–º–µ—Å—Ç–∏–ª)
    const authorInitial = rawAuthor ? rawAuthor.trim().charAt(0).toUpperCase() + '.' : '–ù–µ —É–∫–∞–∑–∞–Ω';

    if ((statusCode == 404 || statusCode === '404') && url) {
      const errorMessage = `üö´ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ 404
ID: ${id}
${url}

üë§ –ö—Ç–æ —Ä–∞–∑–º–µ—â–∞–ª: ${authorInitial}`;
      sendTelegramMessage(errorMessage);
    }
  }
}

function sendTelegramMessage(message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'Markdown'
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true,
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const code = response.getResponseCode();
    if (code >= 200 && code < 300) {
      return { success: true };
    } else {
      return { success: false, error: `–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ Telegram: ${code}` };
    }
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function logScriptRun(processedCount, errors) {
  const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('–õ–æ–≥ —Å–∫—Ä–∏–ø—Ç–æ–≤');
  const now = new Date();
  const date = Utilities.formatDate(now, Session.getScriptTimeZone(), 'dd.MM.yyyy');
  const time = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');

  const newRow = [[
    date,                                 // M ‚Äî –¥–∞—Ç–∞
    time,                                 // N ‚Äî –≤—Ä–µ–º—è
    errors.length === 0 ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ö†Ô∏è –° –æ—à–∏–±–∫–∞–º–∏', // O ‚Äî —Å—Ç–∞—Ç—É—Å —Å–∫—Ä–∏–ø—Ç–∞
    processedCount > 0 ? `üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${processedCount}` : 'üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫', // P ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ
    errors.join('; ') || ''               // Q ‚Äî –æ—à–∏–±–∫–∏
  ]];

  const rangeToMove = logSheet.getRange(7, 13, logSheet.getLastRow() - 6, newRow[0].length);
  rangeToMove.moveTo(logSheet.getRange(8, 13)); // —Å–¥–≤–∏–≥–∞–µ–º –≤—Å—ë –≤–Ω–∏–∑ –Ω–∞—á–∏–Ω–∞—è —Å 8 —Å—Ç—Ä–æ–∫–∏
  logSheet.getRange(7, 13, 1, newRow[0].length).setValues(newRow); // –ø–∏—à–µ–º –≤ 7 —Å—Ç—Ä–æ–∫—É
}


/**
 * üìÑ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –≤–µ—Ä—Å–∏–∏ v1.3.2:
 * 
 * –°–∫—Ä–∏–ø—Ç –∏—â–µ—Ç –Ω–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ B (–Ω–∞—á–∏–Ω–∞—è —Å 7-–π —Å—Ç—Ä–æ–∫–∏) –ª–∏—Å—Ç–∞ "404 (–Ω–µ –º–µ–Ω—è—Ç—å!)".
 * –ï—Å–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ C —Ä—è–¥–æ–º —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–µ—Ç –æ—Ç–º–µ—Ç–∫–∏ ‚Äî —Å–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤ Telegram.
 * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è, –∫—Ç–æ —Ä–∞–∑–º–µ—Å—Ç–∏–ª —Å—Å—ã–ª–∫—É (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ F).
 * –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:
 *   üì∞ –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–º–µ—â—ë–Ω:
 *   https://example.com
 *   
 *   üë§ –ö—Ç–æ —Ä–∞–∑–º–µ—Å—Ç–∏–ª: –ê.
 * –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫—É C –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è.
 * –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫—É "–õ–æ–≥ —Å–∫—Ä–∏–ø—Ç–æ–≤" (–≤ —Å—Ç—Ä–æ–∫—É 7, –æ—Ç –∫–æ–ª–æ–Ω–∫–∏ M).
 */

/**
 * üìÑ –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ v1.3.4:
 * –ï—Å–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ D —É–∫–∞–∑–∞–Ω–æ 404 (—á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π), –∏ –≤ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ (–≤ –∫–æ–ª–æ–Ω–∫–µ B),
 * —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram –≤–∏–¥–∞:
 * üö´ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ 404
 * ID: 123
 * https://example.com
 * 
 * üë§ –ö—Ç–æ —Ä–∞–∑–º–µ—â–∞–ª: –ê.
 * 
 * –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–∂–µ –≤–∑—è–ª–∏ –≤ —Ä–∞–±–æ—Ç—É, –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è.
 */
